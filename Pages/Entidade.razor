@page "/entidades"
@using BlazorInputMask;
@inject IJSRuntime JS

@using doe_mais_ads.Models;
@using doe_mais_ads.Service;

@inject EntidadeService entidadeService;

<PageTitle>Entidades</PageTitle>

<div class="flex flex-col gap-4 h-full">
    <div class="w-full bg-zinc-100 p-4 rounded-lg flex flex-col gap-3">
        <span class="text-2xl font-bold">Entidades</span>
        <span class="text-sm font-normal text-gray-500">
            @* Descrição *@
            Cadastre-se aqui para registrar doadores e receptores de itens em nosso sistema de doações. Se você é um
            doador, forneça suas informações para que possamos coordenar a doação. Se você é um receptor, informe suas
            necessidades para receber o suporte adequado. O cadastro ajuda a garantir que as doações sejam bem
            direcionadas e reconhecidas. Preencha o formulário abaixo e faça a diferença!
        </span>
    </div>

    <div class="flex flex-col gap-6">
        <div class="flex flex-row gap-4 h-24">
            <button data-modal-target="new-entity-modal" data-modal-toggle="new-entity-modal"
                class="relative items-center drop-shadow-md justify-center p-1 flex overflow-hidden text-sm font-medium text-gray-900 rounded-lg group bg-gradient-to-br from-green-400 to-blue-600 group-hover:from-green-400 group-hover:to-blue-600 hover:text-white dark:text-white focus:ring-4 focus:outline-none focus:ring-green-200 dark:focus:ring-green-800">
                <span
                    class="relative w-60 p-4 h-full flex items-center justify-center transition-all ease-in duration-75 bg-white dark:bg-gray-900 rounded-md group-hover:bg-opacity-0">
                    Nova Entidade
                </span>
            </button>

            <div
                class="relative items-center w-full drop-shadow-md justify-center p-1 flex overflow-hidden text-sm font-medium text-gray-900 rounded-lg group bg-gradient-to-br from-green-400 to-blue-600  dark:text-white focus:ring-4 focus:outline-none focus:ring-green-200 dark:focus:ring-green-800">
                <div
                    class="relative w-full p-2 h-full flex items-center justify-center transition-all ease-in duration-75 bg-white dark:bg-gray-900 rounded-md">
                    <div class="flex flex-row gap-2 h-full w-full">
                        <div class="w-full">
                            <label for="first_name"
                                class="block mb-1 text-sm font-medium text-gray-900 dark:text-white">Pesquisar por
                                nome</label>
                            <input type="text" id="first_name"
                                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                                placeholder="Amanda Alves" required />
                        </div>
                        <form class="w-1/2">
                            <label for="teste1"
                                class="block mb-1 text-sm font-medium text-gray-900 dark:text-white">Ordenar por
                            </label>
                            <select id="teste1"
                                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                                <option selected>Selecione...</option>
                                <option value="US">Data registro (crescente)</option>
                                <option value="CA">Data registro (decrescente)</option>
                                <option value="FR">Nome (crescente)</option>
                                <option value="DE">Nome (decrescente)</option>
                            </select>
                        </form>
                        <form class="w-1/2">
                            <label for="teste2"
                                class="block mb-1 text-sm font-medium text-gray-900 dark:text-white">Ordenar por
                            </label>
                            <select id="teste2"
                                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                                <option selected>Selecione...</option>
                                <option value="US">Data registro (crescente)</option>
                                <option value="CA">Data registro (decrescente)</option>
                                <option value="FR">Nome (crescente)</option>
                                <option value="DE">Nome (decrescente)</option>
                            </select>
                        </form>
                    </div>
                </div>
            </div>
        </div>


        <div class="flex flex-col gap-4 pb-20">
            @if(entities.Count == 0)
            {
                <div class="h-40 flex w-full justify-center items-center text-start">
                    <div class="text-base font-semibold text-gray-500">
                        Nenhuma entidade cadastrada
                    </div>
                </div>
            } else {                
            foreach (var item in entities)
                {
                    <div class="flex flex-col gap-8 bg-zinc-100 p-3 rounded-lg">                        
                        <div class="flex flex-row gap-8 h-full p-3">
                            <div class="text-start flex gap-1 flex-col">
                                <div class="text-base font-normal text-gray-600">
                                    Tipo
                                </div>
                                <div class="py-1 px-3 group bg-gradient-to-br from-green-400 to-blue-600 rounded-md text-white">
                                    @if( item.IsPessoaFisica ) {
                                        <span class="text-sm font-semibold">Pessoa Física</span>
                                    } else {
                                        <span class="text-sm font-semibold">Pessoa Jurídica</span>
                                    }
                                </div>
                            </div>

                            @if( item.IsPessoaFisica ) {
                                <div class="text-start flex gap-1 flex-col">
                                    <div class="text-base font-normal text-gray-600">
                                        Nome
                                    </div>
                                    <div class="text-base font-semibold py-1 w-56">
                                        @item.Nome
                                    </div>
                                </div>
                                <div class="text-start flex gap-1 flex-col">
                                    <div class="text-base font-normal text-gray-600">
                                        CPF
                                    </div>
                                    <div class="text-base font-semibold py-1">
                                        @item.Cpf
                                    </div>
                                </div>                  
                            } else {
                                <div class="text-start flex gap-1 flex-col">
                                    <div class="text-base font-normal text-gray-600">
                                        Nome Fantasia
                                    </div>
                                    <div class="text-base font-semibold py-1 line-clamp-1 w-56">
                                        @item.NomeFantasia
                                    </div>
                                </div>     

                                <div class="text-start flex gap-1 flex-col">
                                    <div class="text-base font-normal text-gray-600">
                                        CNPJ
                                    </div>
                                    <div class="text-base font-semibold py-1">
                                        @item.Cnpj
                                    </div>
                                </div>                 
                            }

                            <div class="text-start flex gap-1 flex-col">
                                <div class="text-base font-normal text-gray-600">
                                    Email
                                </div>
                                <div class="text-base font-semibold py-1">
                                    @item.Email
                                </div>
                            </div>

                            <div class="text-start flex gap-1 flex-col">
                                <div class="text-base font-normal text-gray-600">
                                    Telefone
                                </div>
                                <div class="text-base font-semibold py-1">
                                    @item.Telefone
                                </div>
                            </div>

                            @item.Id
                        </div>

                        <div class="flex w-full justify-end">
                            <div class="bg-white rounded-md p-3 flex gap-6 flex-row justify-center items-center">
                                <button @onclick="() => openModalUpdateEntity(item)" data-modal-target="new-entity-modal" data-modal-toggle="new-entity-modal" class="relative items-center drop-shadow-md justify-center p-[2px] flex overflow-hidden text-sm font-medium text-gray-900 rounded group bg-gradient-to-br from-zinc-500 to-blue-600 group-hover:from-zinc-400 group-hover:to-blue-600 hover:text-white dark:text-white focus:ring-4 focus:outline-none focus:ring-zinc-200 dark:focus:ring-zinc-800">
                                    <span
                                        class="relative p-1 px-4 h-full flex items-center justify-center transition-all ease-in duration-75 bg-white dark:bg-gray-900 rounded-sm group-hover:bg-opacity-0">
                                        Editar Entidade
                                    </span>
                                </button>
                                
                                <button @onclick="() => deleteEntity(item)"  class="relative items-center drop-shadow-md justify-center p-[2px] flex overflow-hidden text-sm font-medium text-gray-900 rounded group bg-gradient-to-br from-zinc-500 to-red-600 group-hover:from-zinc-400 group-hover:to-red-600 hover:text-white dark:text-white focus:ring-4 focus:outline-none focus:ring-zinc-200 dark:focus:ring-zinc-800">
                                    <span
                                        class="relative p-1 px-4 h-full flex items-center justify-center transition-all ease-in duration-75 bg-white dark:bg-gray-900 rounded-sm group-hover:bg-opacity-0">
                                        Excluir Entidade
                                    </span>
                                </button>
                            </div>
                        </div>
                    </div>
                }
            }
        </div>
    </div>

    <div id="new-entity-modal" tabindex="-1" aria-hidden="true"
        class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
        <div class="relative p-4 w-full max-w-md max-h-full">
            <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
                <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600">
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
                        Cadastrar Entidade
                    </h3>
                    <button type="button"
                        class="end-2.5 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white"
                        data-modal-hide="new-entity-modal">
                        <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none"
                            viewBox="0 0 14 14">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
                        </svg>
                        <span class="sr-only">Close modal</span>
                    </button>
                </div>
                <div class="p-4 md:p-5">
                    <form class="space-y-4" @onsubmit="SaveOrUpdateEntity">
                        <ul
                            class="items-center w-full text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-lg sm:flex dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <li class="w-full border-b border-gray-200 sm:border-b-0 sm:border-r dark:border-gray-600">
                                <div class="flex items-center ps-3">
                                    <input id="juridica-checkbox-list" type="checkbox" @bind="checkJuridica" disabled="@disableCheckJuridica"
                                        @bind:after="onChangeCheckboxJuridica"
                                        class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-700 dark:focus:ring-offset-gray-700 focus:ring-2 dark:bg-gray-600 dark:border-gray-500">
                                    <label for="juridica-checkbox-list"
                                        class="w-full py-3 ms-2 text-sm font-medium text-gray-900 dark:text-gray-300">
                                        Pessoa Jurídica
                                    </label>
                                </div>
                            </li>
                            <li class="w-full border-b border-gray-200 sm:border-b-0 sm:border-r dark:border-gray-600">
                                <div class="flex items-center ps-3">
                                    <input id="fisica-checkbox-list" type="checkbox" @bind="@checkFisica" disabled="@disableCheckFisica"
                                        @bind:after="onChangeCheckboxFisica"
                                        class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-700 dark:focus:ring-offset-gray-700 focus:ring-2 dark:bg-gray-600 dark:border-gray-500">
                                    <label for="fisica-checkbox-list"
                                        class="w-full py-3 ms-2 text-sm font-medium text-gray-900 dark:text-gray-300">Pessoa
                                        Física</label>
                                </div>
                            </li>
                        </ul>

                        @if(checkFisica) {
                        <div>
                            <label for="name" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                                Nome
                            </label>
                            <input name="name" id="name" @bind="entity.Nome"
                                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white"
                                placeholder="Nome..." required />
                        </div>

                            <div>
                                <label for="cpf" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                                    CPF
                                </label>
                                <InputMask name="cpf" @bind-Value="entity.Cpf" id="cpf" data-mask="000.000.000-00"
                                    class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white"
                                    placeholder="000.000.000-00" required />
                            </div>
                        }

                        @if(checkJuridica) {
                            <div>
                                <label for="nameFantasy" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                                    Nome fantasia
                                </label>
                                <input name="nameFantasy" id="nameFantasy" @bind="entity.NomeFantasia"
                                    class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white"
                                    placeholder="Nome fantasia..." required />
                            </div>

                            <div>
                                <label for="cnpj" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                                    CNPJ
                                </label>
                                <InputMask name="cnpj" id="cnpj" data-mask="00 000 000/0000-00" @bind-Value="entity.Cnpj"
                                    class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white"
                                    placeholder="00 000 000/0000-0" required />
                            </div>
                        }

                        <div>
                            <label for="email" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                                Email
                            </label>
                            <input type="email" name="email" id="email" @bind="entity.Email"
                                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white"
                                placeholder="name@company.com" required />
                        </div>

                        <div>
                                <label for="telefone" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                                    Telefone
                                </label>
                                <InputMask name="telefone" id="telefone" data-mask="(00) 0 0000-0000" @bind-Value="entity.Telefone"
                                    class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white"
                                    placeholder="(00) 0 0000-0000" required />
                            </div>

                            @if(isUpdate) {
                                <button type="submit" data-modal-hide="new-entity-modal"
                                class="w-full text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
                                    <span>Atualizar Entidade</span>
                                </button>
                            } else {
                                <button type="submit"
                                class="w-full text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
                                    <span>Cadastrar Entidade</span>
                                </button>
                            }
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    protected override async Task OnAfterRenderAsync(bool isFirstRender) {
        if (isFirstRender){
            await JS.InvokeVoidAsync("initFlowbite");
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await getAllEntities();
    }

    public Entity entity = new Entity();
    private bool checkJuridica = false;
    private bool disableCheckJuridica = false;

    private bool isUpdate = false;
    private bool checkFisica = true;
    private bool disableCheckFisica = true;

    private List<Entity> entities = new List<Entity>();

    private void onChangeCheckboxJuridica()
    {
        checkFisica = false;
        disableCheckJuridica = true;
        disableCheckFisica = false;
    }
    private void onChangeCheckboxFisica()
    {
        checkJuridica = false;
        disableCheckJuridica = false;
        disableCheckFisica = true;
    }

    private void openModalUpdateEntity(Entity entityUpdate)
    {
        entity.Id = entityUpdate.Id;
        entity.Nome = entityUpdate.Nome;
        entity.NomeFantasia = entityUpdate.NomeFantasia;
        entity.Cpf = entityUpdate.Cpf;
        entity.Cnpj = entityUpdate.Cnpj;
        entity.Email = entityUpdate.Email;
        entity.Telefone = entityUpdate.Telefone;
        entity.IsPessoaFisica = entityUpdate.IsPessoaFisica;
    }

    private async Task SaveOrUpdateEntity()
    {   
        if(entity.Id != null && entity.Id > 0)
        {
            Console.WriteLine("Update");
            isUpdate = true;
            await entidadeService.UpdateEntidade(entity);
        } else {
            var newEntity = new Entity()
            {
                Nome = entity.Nome,
                NomeFantasia = entity.NomeFantasia,
                Cpf = entity.Cpf,
                Cnpj = entity.Cnpj,
                Email = entity.Email,
                Telefone = entity.Telefone,
                IsPessoaFisica = checkFisica
            };

            await entidadeService.AddEntidade(newEntity);
        }

        isUpdate = false;

        await getAllEntities();
        clearEntityInputs();
    }

    private async Task deleteEntity(Entity entity)
    {
        await entidadeService.DeleteEntidade(entity.Id!.Value);
        await getAllEntities();
    }

    private async Task getAllEntities()
    {   
        entities = [];

        entities = await entidadeService.GetAllEntidades();
    }

    private void clearEntityInputs() {
        entity.Nome = "";
        entity.NomeFantasia = "";
        entity.Cpf = "";
        entity.Cnpj = "";
        entity.Email = "";
        entity.Telefone = "";
        entity.IsPessoaFisica = true;
    }
}
